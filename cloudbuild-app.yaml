steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: Build Image
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$_CONTAINER_PROJECT_ID/$REPO_NAME:$SHORT_SHA'
      - '.'
  - name: 'gcr.io/cloud-builders/docker'
    id: Push Image
    args:
      - 'push'
      - 'gcr.io/$_CONTAINER_PROJECT_ID/$REPO_NAME:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Decrypt Key
    args: 
    - kms
    - decrypt
    - --ciphertext-file=id_rsa_gcloud.enc
    - --plaintext-file=/root/.ssh/id_rsa
    - --location=global
    - --keyring=main-keyring
    - --key=main-key
    volumes:
    - name: 'ssh'
      path: /root/.ssh

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Give Git Permissions
    entrypoint: /bin/sh
    args:
    - '-c'
    - |
      chmod 600 /root/.ssh/id_rsa
      cat <<EOF >/root/.ssh/config
      Hostname github.com
      IdentityFile /root/.ssh/id_rsa
      EOF
      mv known_hosts /root/.ssh/known_hosts
    volumes:
    - name: 'ssh'
      path: /root/.ssh      

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Clone the ENV Repository
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        git clone ${_ENV_REPOSITORY_URL} && \
        cd ${_ENV_REPOSITORY_NAME} && \
        git checkout ${_ENV_REPOSITORY_BRANCH} && \
        git config user.email ${_GITHUB_EMAIL_ADDRESS}
    volumes:
    - name: 'ssh'
      path: /root/.ssh
    
  - name: 'gcr.io/cloud-builders/gcloud'
    id: Generate New Manifest
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        mkdir -p ${_ENV_REPOSITORY_NAME}/k8s && \
        sed "s/_CONTAINER_PROJECT_ID/${_CONTAINER_PROJECT_ID}/g" kubernetes-deployment.yaml.tpl | \
        sed "s/REPO_NAME/${REPO_NAME}/g" | \
        sed "s/SHORT_SHA/${SHORT_SHA}/g" > ${_ENV_REPOSITORY_NAME}/k8s/${REPO_NAME}-deployment.yaml

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Push New Manifest
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        set -x && \
        cd ${_ENV_REPOSITORY_NAME} && \
        git add k8s/${REPO_NAME}-deployment.yaml && \
        git commit -m "Deploying image gcr.io/${_CONTAINER_PROJECT_ID}/${REPO_NAME}:${SHORT_SHA}
        Built from commit ${COMMIT_SHA} of repository ${REPO_NAME}
        Author $(git log --format='%an <%ae>' -n 1 HEAD)" && \
        git push origin ${_ENV_REPOSITORY_BRANCH}
    volumes:
    - name: 'ssh'
      path: /root/.ssh
        
images:
  - 'gcr.io/$_CONTAINER_PROJECT_ID/$REPO_NAME:$SHORT_SHA'
                                                  